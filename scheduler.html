<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russian UI Modal</title>
    <!-- Добавляем Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="/styles_scheduler.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<body>
    <!-- Добавляем контейнер для карты (он будет фоном, модалка overlay поверх него) -->
    <div id="map" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;"></div>

    <div class="overlay" style="z-index: 2; position: relative; ">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <button class="menu-btn" aria-label="Меню">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                    </svg>
                </button>

                <div class="search-container">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" />
                        <path d="м21 21-4.35-4.35" stroke="currentColor" stroke-width="2" />
                    </svg>
                    <input type="text" class="search-input" placeholder="Введите название места...">
                </div>

                <button class="profile-btn">ЛК</button>
            </header>

            <!-- Navigation Tabs -->
            <nav class="nav-tabs">
                <button class="nav-tab">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
                <button class="nav-tab active">Дни</button>
                <button class="nav-tab">Точки</button>
                <button class="nav-tab">Протяженность</button>
            </nav>

            <!-- Modal Content -->
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Название</h2>
                </div>

                <div id="tab-content-days" class="tab-content" style="display: block;">
                    <div class="modal-controls">
                        <button class="control-btn active">+ День</button>
                        <button class="control-btn">- День</button>
                        <button class="control-btn">+ запись</button>
                        <button class="control-btn">- запис</button>
                    </div>

                    <div class="days-list">
                        <div class="day-item">День 1</div>
                    </div>
                </div>

                <div id="tab-content-points" class="tab-content" style="display: none;">
                    <div class="modal-controls">
                        <button class="control-btn active">+ День</button>
                        <button class="control-btn">- День</button>

                    </div>

                    <div class="days-list">
                        <div class="day-item">Нет точек</div>
                    </div>
                </div>

                <div id="tab-content-distance" class="tab-content" style="display: none;">
                    <div class="modal-controls">
                        <button class="control-btn active">+ День</button>
                        <button class="control-btn">- День</button>
                    </div>

                    <div class="days-list">
                        <div class="day-item">Нет точек</div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="clear-btn-custom" class="action-btn secondary">Очистить</button>
                    <button class="action-btn primary">Сохранить</button>
                </div>
            </div>
            <div class="resizer"></div>
        </div>
    </div>

    <!-- Добавляем Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Инициализация карты
            const map = L.map('map', { zoomControl: false }).setView([55.7558, 37.6173], 10);

            L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap | OpenTopoMap',
                maxZoom: 17
            }).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);

            let markers = [];  // Храним объекты маркеров
            let pointNames = []; // Храним имена точек
            let routeLayer = null;  // Храним слой маршрута
            let dashedLayers = [];  // Храним пунктирные линии для очистки
            let routeData = null; // Храним данные маршрута
            let routeName = 'Название'; // Имя маршрута для заголовка


            // Set transition for smooth height change
            const container = document.querySelector('.container');
            container.style.transition = 'height 0.3s ease-in-out';
            container.style.overflow = 'hidden';

            const modalTitle = document.querySelector('.modal-title');
            modalTitle.textContent = routeName;

            // Добавляем возможность редактирования заголовка только в вкладке "Дни"
            modalTitle.addEventListener('dblclick', () => {
                if (document.getElementById('tab-content-days').style.display !== 'block') return;
                modalTitle.contentEditable = true;
                modalTitle.focus();
            });

            modalTitle.addEventListener('blur', () => {
                modalTitle.contentEditable = false;
                const newName = modalTitle.textContent.trim();
                routeName = newName ? newName : 'Название';
                modalTitle.textContent = routeName;
            });

            modalTitle.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    modalTitle.blur();
                }
            });

            // КЛИК ПО КАРТЕ
            map.on('click', async function (e) {
                if (markers.length >= 20) {
                    alert('Дорогой пользователь, на карту можно наносить только до 20 меток');
                    return;
                }
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                // 1. Ставим обычный синий маркер (без цифр)
                const marker = L.marker([lat, lng]).addTo(map);

                // Добавляем всплывашку, чтобы можно было удалить (опционально)
                marker.bindPopup("Точка маршрута").on('click', () => {
                    // Тут можно добавить логику удаления при клике на сам маркер
                });

                markers.push(marker);
                pointNames.push(`Точка ${markers.length}`);

                // Update points list
                updatePointsList();

                // 2. Если есть минимум 2 точки — строим маршрут
                if (markers.length >= 2) {
                    await buildRoute();
                    updateDistanceList();
                    updateTitle(); // Update title dynamically
                }
            });

            // ФУНКЦИЯ ПОСТРОЕНИЯ МАРШРУТА
            async function buildRoute() {
                // Собираем координаты: [[lon, lat], [lon, lat]]
                const coords = markers.map(m => [m.getLatLng().lng, m.getLatLng().lat]);

                try {
                    const response = await fetch('/generate-route', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ coordinates: coords })
                    });

                    const data = await response.json();
                    routeData = data;

                    if (!response.ok) {
                        // Если ошибка (например, далеко от дороги), выводим alert, но не ломаем карту
                        console.warn(data.error);
                        alert(data.error || 'Ошибка построения');
                        return;
                    }

                    // Удаляем старую линию и пунктиры
                    if (routeLayer) map.removeLayer(routeLayer);
                    dashedLayers.forEach(layer => map.removeLayer(layer));
                    dashedLayers = [];

                    // Рисуем основную линию (Синюю для вело)
                    routeLayer = L.geoJSON(data.geometry, {
                        style: { color: '#007bff', weight: 5, opacity: 0.8 }
                    }).addTo(map);

                    // ДОСТРОЙКА ПУНКТИРОМ: Для каждой точки, если snapped != user
                    data.snapped_waypoints.forEach((snap, i) => {
                        if (snap.distance > 1) {  // Если >1м, достраиваем пунктир
                            const userLatLng = markers[i].getLatLng();
                            const snappedLatLng = L.latLng(snap.location[1], snap.location[0]);  // [lon, lat] -> latLng

                            const dashed = L.polyline([userLatLng, snappedLatLng], {
                                color: 'gray',
                                weight: 3,
                                dashArray: '5, 5',
                                opacity: 0.7
                            }).addTo(map);

                            dashedLayers.push(dashed);
                        }
                    });

                    // Фокусируем карту на маршруте (учитывая пунктиры)
                    const bounds = routeLayer.getBounds();
                    dashedLayers.forEach(d => bounds.extend(d.getBounds()));
                    map.fitBounds(bounds, { padding: [50, 50] });

                    // Обновляем инфо-панель
                    displayRouteInfo(data);

                } catch (error) {
                    console.error('Ошибка сети:', error);
                }
            }

            // Function to update points list in "Точки" tab
            function updatePointsList() {
                const pointsList = document.querySelector('#tab-content-points .days-list');
                if (!pointsList) return;

                pointsList.innerHTML = '';

                if (markers.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'day-item';
                    emptyItem.textContent = 'Нет точек';
                    pointsList.appendChild(emptyItem);
                } else {
                    markers.forEach((marker, index) => {
                        const pointItem = document.createElement('div');
                        pointItem.className = 'day-item';
                        pointItem.style.display = 'flex';
                        pointItem.style.alignItems = 'center';

                        // Иконка метки
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-map-marker-alt';
                        icon.style.color = '#3388ff';
                        icon.style.marginRight = '10px';
                        icon.style.cursor = 'pointer';
                        icon.addEventListener('click', () => {
                            map.flyTo(marker.getLatLng(), 15);
                        });

                        // Текст точки (редактируемый)
                        const textSpan = document.createElement('span');
                        textSpan.textContent = pointNames[index];
                        textSpan.style.cursor = 'text';
                        textSpan.style.flex = '1';
                        textSpan.addEventListener('dblclick', () => {
                            textSpan.contentEditable = true;
                            textSpan.focus();
                        });
                        textSpan.addEventListener('blur', () => {
                            textSpan.contentEditable = false;
                            const newName = textSpan.textContent.trim();
                            pointNames[index] = newName ? newName : `Точка ${index + 1}`;
                            updateDistanceList(); // Обновляем список расстояний при изменении имени
                            updateTitle(); // Update title if needed
                        });
                        textSpan.addEventListener('keyup', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                textSpan.blur();
                            }
                        });

                        pointItem.appendChild(icon);
                        pointItem.appendChild(textSpan);
                        pointsList.appendChild(pointItem);
                    });
                }
            }

            // Function to update distance list in "Протяженность" tab
            function updateDistanceList() {
                const distanceList = document.querySelector('#tab-content-distance .days-list');
                if (!distanceList) return;

                distanceList.innerHTML = '';

                if (markers.length < 2 || !routeData || !routeData.segments) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'day-item';
                    emptyItem.textContent = 'Нет данных';
                    distanceList.appendChild(emptyItem);
                    return;
                }

                routeData.segments.forEach((seg, index) => {
                    const item = document.createElement('div');
                    item.className = 'day-item';
                    const name1 = pointNames[index];
                    const name2 = pointNames[index + 1];
                    let dist = seg.distance || '0 км';
                    let d = parseFloat(dist);
                    if (isNaN(d) || d === 0) {
                        const latlng1 = markers[index].getLatLng();
                        const latlng2 = markers[index + 1].getLatLng();
                        const calcDist = (latlng1.distanceTo(latlng2) / 1000).toFixed(2);
                        dist = calcDist + ' км';
                    }
                    item.textContent = `${name1}:${name2} - ${dist}`;
                    distanceList.appendChild(item);
                });
            }

            // Function to get current tab ID
            function getCurrentTabId() {
                const activeTab = document.querySelector('.nav-tab.active');
                if (!activeTab) return null;
                const index = Array.from(document.querySelectorAll('.nav-tab')).indexOf(activeTab);
                if (index === 0) return null;
                return index === 1 ? 'days' : index === 2 ? 'points' : 'distance';
            }

            // Function to update title based on current tab
            function updateTitle() {
                const tabId = getCurrentTabId();
                if (tabId === 'distance') {
                    let totalDistNum = 0;
                    if (routeData && routeData.segments && markers.length >= 2) {
                        routeData.segments.forEach((seg, i) => {
                            let d = parseFloat(seg.distance || 0);
                            if (isNaN(d) || d === 0) {
                                const latlng1 = markers[i].getLatLng();
                                const latlng2 = markers[i + 1].getLatLng();
                                d = latlng1.distanceTo(latlng2) / 1000;
                            }
                            totalDistNum += d;
                        });
                    }
                    const totalDist = totalDistNum.toFixed(2) + ' км';
                    modalTitle.textContent = `Общее расстояние - ${totalDist}`;
                } else {
                    modalTitle.textContent = routeName;
                }
            }

            // КНОПКА УБРАТЬ МЕТКУ
            const modalActions = document.querySelector('.modal-actions');
            // Проверяем, нет ли уже кнопки, чтобы не дублировать
            if (!document.getElementById('clear-btn-custom')) {
                const clearBtn = document.createElement('button');
                clearBtn.id = 'clear-btn-custom';
                clearBtn.className = 'action-btn secondary';
                clearBtn.textContent = 'убрать метку';
                clearBtn.onclick = async () => {
                    if (markers.length > 0) {
                        const lastMarker = markers.pop();
                        map.removeLayer(lastMarker);
                        pointNames.pop();
                        updatePointsList();
                        if (markers.length >= 2) {
                            await buildRoute();
                        } else {
                            if (routeLayer) {
                                map.removeLayer(routeLayer);
                                routeLayer = null;
                            }
                            dashedLayers.forEach(d => map.removeLayer(d));
                            dashedLayers = [];
                            routeData = null;
                        }
                        updateDistanceList();
                        updateTitle();
                    }
                };
                modalActions.prepend(clearBtn); // Добавляем кнопку в начало
            } else {
                const existingClearBtn = document.getElementById('clear-btn-custom');
                existingClearBtn.textContent = 'убрать метку';
                existingClearBtn.onclick = async () => {
                    if (markers.length > 0) {
                        const lastMarker = markers.pop();
                        map.removeLayer(lastMarker);
                        pointNames.pop();
                        updatePointsList();
                        if (markers.length >= 2) {
                            await buildRoute();
                        } else {
                            if (routeLayer) {
                                map.removeLayer(routeLayer);
                                routeLayer = null;
                            }
                            dashedLayers.forEach(d => map.removeLayer(d));
                            dashedLayers = [];
                            routeData = null;
                        }
                        updateDistanceList();
                        updateTitle();
                    }
                };
            }

            // Tab switching logic
            const navTabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            navTabs.forEach((tab, index) => {
                tab.addEventListener('click', function () {
                    navTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Hide all tab contents
                    tabContents.forEach(content => content.style.display = 'none');

                    // Show the corresponding content (skip the first tab if it's close button)
                    if (index === 0) {
                        // Assuming first tab is close or something else, do nothing or handle close
                        console.log('Закрыть или другая логика');
                        return;
                    }

                    const tabId = index === 1 ? 'days' : index === 2 ? 'points' : 'distance';
                    document.getElementById(`tab-content-${tabId}`).style.display = 'block';

                    updateTitle();
                });
            });

            // Initialize control buttons for each tab content
            const allControlBtns = document.querySelectorAll('.tab-content .control-btn');
            allControlBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const controls = this.closest('.modal-controls');
                    controls.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Updated initDayControls to handle records as well
            function initDayControls(tabContent) {
                const addDayBtn = tabContent.querySelector('.control-btn:nth-child(1)');
                const removeDayBtn = tabContent.querySelector('.control-btn:nth-child(2)');
                const addRecordBtn = tabContent.querySelector('.control-btn:nth-child(3)');
                const removeRecordBtn = tabContent.querySelector('.control-btn:nth-child(4)');
                const daysList = tabContent.querySelector('.days-list');
                let dayCount = 1;

                // Function to create a new day item with record list
                function createDayItem(dayNumber) {
                    const newDay = document.createElement('div');
                    newDay.className = 'day-item';
                    newDay.dataset.dayNumber = dayNumber;

                    // Day header
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = `День ${dayNumber}`;
                    newDay.appendChild(dayHeader);

                    // Record list container
                    const recordList = document.createElement('div');
                    recordList.className = 'record-list';
                    newDay.appendChild(recordList);

                    // Click to select day
                    newDay.addEventListener('click', function () {
                        // Remove active from all days
                        daysList.querySelectorAll('.day-item').forEach(item => item.classList.remove('active'));
                        // Add active to this day
                        this.classList.add('active');
                    });

                    return newDay;
                }

                // Initial day
                daysList.innerHTML = '';
                const initialDay = createDayItem(dayCount);
                daysList.appendChild(initialDay);
                initialDay.classList.add('active'); // Make first day active by default

                // Add day
                addDayBtn.addEventListener('click', function () {
                    dayCount++;
                    const newDay = createDayItem(dayCount);
                    daysList.appendChild(newDay);
                });

                // Remove day
                removeDayBtn.addEventListener('click', function () {
                    if (dayCount > 1) {
                        daysList.removeChild(daysList.lastChild);
                        dayCount--;
                        // Ensure there's always an active day
                        const remainingDays = daysList.querySelectorAll('.day-item');
                        if (remainingDays.length > 0 && !daysList.querySelector('.day-item.active')) {
                            remainingDays[remainingDays.length - 1].classList.add('active');
                        }
                    }
                });

                // Function to show marker list popover
                function showMarkerList(selectorElement) {
                    if (pointNames.length === 0) {
                        alert('Нет доступных меток');
                        return;
                    }

                    const popover = document.createElement('div');
                    popover.className = 'popover';
                    popover.style.position = 'absolute';
                    popover.style.background = 'white';
                    popover.style.border = '1px solid #ccc';
                    popover.style.padding = '5px';
                    popover.style.zIndex = '1000';
                    popover.style.maxHeight = '200px';
                    popover.style.overflowY = 'auto';

                    pointNames.forEach((name, index) => {
                        const option = document.createElement('div');
                        option.textContent = name;
                        option.style.cursor = 'pointer';
                        option.style.padding = '5px';
                        option.addEventListener('mouseover', () => {
                            option.style.background = '#f0f0f0';
                        });
                        option.addEventListener('mouseout', () => {
                            option.style.background = 'white';
                        });
                        option.addEventListener('click', () => {
                            // Replace selector with icon and name
                            selectorElement.innerHTML = '';
                            const icon = document.createElement('i');
                            icon.className = 'fas fa-map-marker-alt';
                            icon.style.color = '#3388ff';
                            icon.style.marginRight = '5px';
                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = name;
                            selectorElement.appendChild(icon);
                            selectorElement.appendChild(nameSpan);
                            // Remove popover
                            popover.remove();
                        });
                        popover.appendChild(option);
                    });

                    // Position popover below the selector
                    document.body.appendChild(popover);
                    const rect = selectorElement.getBoundingClientRect();
                    popover.style.left = `${rect.left + window.scrollX}px`;
                    popover.style.top = `${rect.bottom + window.scrollY}px`;

                    // Remove popover on outside click
                    const outsideClick = (e) => {
                        if (!popover.contains(e.target) && e.target !== selectorElement) {
                            popover.remove();
                            document.removeEventListener('click', outsideClick);
                        }
                    };
                    document.addEventListener('click', outsideClick);
                }

                // Function to create a new record item
                function createRecordItem() {
                    const newRecord = document.createElement('div');
                    newRecord.className = 'record-item';
                    newRecord.style.display = 'flex';
                    newRecord.style.alignItems = 'center';
                    newRecord.style.marginTop = '5px';

                    // Marker selector (initially empty square)
                    const selector = document.createElement('div');
                    selector.className = 'marker-selector';
                    selector.innerHTML = '&#9744;'; // Unicode for empty checkbox square
                    selector.style.cursor = 'pointer';
                    selector.style.marginRight = '10px';
                    selector.style.fontSize = '16px';
                    selector.addEventListener('click', function (e) {
                        e.stopPropagation();
                        showMarkerList(this);
                    });
                    newRecord.appendChild(selector);

                    // Dash
                    const dash = document.createElement('span');
                    dash.textContent = ' - ';
                    newRecord.appendChild(dash);

                    // Time input (editable time in format 0:00)
                    const timeInput = document.createElement('input');
                    timeInput.type = 'time';
                    timeInput.value = '00:00'; // Default to 00:00
                    timeInput.style.border = 'none';
                    timeInput.style.background = 'transparent';
                    timeInput.style.width = '80px'; // Increased width to ensure all digits are visible
                    timeInput.style.color = 'inherit'; // Inherit color from parent to match "День 1" text color
                    newRecord.appendChild(timeInput);

                    return newRecord;
                }

                // Add record to active day
                addRecordBtn.addEventListener('click', function () {
                    const activeDay = daysList.querySelector('.day-item.active');
                    if (activeDay) {
                        const recordList = activeDay.querySelector('.record-list');
                        const newRecord = createRecordItem();
                        recordList.appendChild(newRecord);
                    } else {
                        alert('Выберите день для добавления записи');
                    }
                });

                // Remove last record from active day
                removeRecordBtn.addEventListener('click', function () {
                    const activeDay = daysList.querySelector('.day-item.active');
                    if (activeDay) {
                        const recordList = activeDay.querySelector('.record-list');
                        if (recordList.lastChild) {
                            recordList.removeChild(recordList.lastChild);
                        }
                    } else {
                        alert('Выберите день для удаления записи');
                    }
                });
            }

            // Initialize for tabs days and cost
            const tabContentsForDays = document.querySelectorAll('.tab-content:not(#tab-content-points):not(#tab-content-distance)');
            tabContentsForDays.forEach(initDayControls);

            // Search input functionality
            const searchInput = document.querySelector('.search-input');

            searchInput.addEventListener('keyup', async function (e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (!query) return;

                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                        const data = await response.json();
                        if (data.length > 0) {
                            const { lat, lon } = data[0];
                            map.flyTo([lat, lon], 14);
                        } else {
                            alert('Такое место не обнаружено');
                        }
                    } catch (error) {
                        console.error('Ошибка поиска:', error);
                        alert('Ошибка при поиске места');
                    }
                }
            });

            // Modal actions
            const saveBtn = document.querySelector('.action-btn.secondary'); // Кнопка очистить
            const exportBtn = document.querySelector('.action-btn.primary'); // Кнопка сохранить

            // ОБНОВЛЕННАЯ ЛОГИКА СОХРАНЕНИЯ
            exportBtn.addEventListener('click', async function () {
                if (markers.length === 0) {
                    alert('Поставьте хотя бы одну метку перед сохранением.');
                    return;
                }

                // 1. Сбор данных о точках (для Custom_Route)
                const pointsData = markers.map(m => {
                    const ll = m.getLatLng();
                    return { lat: ll.lat, lng: ll.lng };
                });

                // 2. Сбор данных РАСПИСАНИЯ (для Route_Schedule)
                const scheduleData = [];
                // Находим все дни
                const dayItems = document.querySelectorAll('#tab-content-days .days-list > .day-item');

                // Для простоты считаем, что День 1 = Сегодня. 
                const today = new Date();

                dayItems.forEach((dayEl, index) => {
                    // Вычисляем дату: Сегодня + index дней
                    const dateObj = new Date(today);
                    dateObj.setDate(today.getDate() + index);
                    const dateStr = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD

                    // Ищем записи внутри дня
                    const records = dayEl.querySelectorAll('.record-item');
                    records.forEach(rec => {
                        // Ищем выбранное имя точки
                        const markerNameSpan = rec.querySelector('.marker-selector span');
                        if (markerNameSpan) {
                            const markerName = markerNameSpan.textContent;
                            // Находим индекс этой точки в массиве pointNames
                            // Добавляем 1, так как в БД WaiPoint1...20
                            const pointIndex = pointNames.indexOf(markerName) + 1;

                            const timeVal = rec.querySelector('input[type="time"]').value;

                            if (pointIndex > 0) {
                                scheduleData.push({
                                    point_index: pointIndex,
                                    visit_date: dateStr,
                                    visit_time: timeVal + ":00" // Добавляем секунды для формата TIME
                                });
                            }
                        }
                    });
                });

                // 3. Вычисление длины 
                let totalMeters = 0;
                let durationStr = "Не рассчитано";

                if (routeData && routeData.distance) {
                    const distFloat = parseFloat(routeData.distance);
                    totalMeters = Math.round(distFloat * 1000);
                    durationStr = routeData.duration || "";
                } else {
                    for (let i = 0; i < markers.length - 1; i++) {
                        totalMeters += markers[i].getLatLng().distanceTo(markers[i + 1].getLatLng());
                    }
                    totalMeters = Math.round(totalMeters);
                }

                // 4. Формируем тело запроса
                const payload = {
                    name: routeName,
                    description: "Пользовательский маршрут",
                    length: totalMeters,
                    duration: durationStr,
                    points: pointsData,
                    schedule: scheduleData // <--- Добавили расписание
                };

                // 5. Отправка на сервер
                try {
                    exportBtn.textContent = "Сохранение...";
                    exportBtn.disabled = true;

                    const response = await fetch('/api/save-custom-route', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Маршрут и расписание успешно сохранены!');
                    } else {
                        alert('Ошибка: ' + (result.error || 'Не удалось сохранить'));
                    }
                } catch (error) {
                    console.error('Ошибка сети:', error);
                    alert('Ошибка сети при сохранении.');
                } finally {
                    exportBtn.textContent = "Сохранить";
                    exportBtn.disabled = false;
                }
            });


            // Close modal on overlay click
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.modal');

            overlay.addEventListener('click', function (e) {
                if (e.target === overlay) {
                    console.log('Закрыть модальное окно');
                }
            });

            // Menu button functionality
            const menuBtn = document.querySelector('.menu-btn');
            let lastHeight = 400; // Высота по умолчанию

            menuBtn.addEventListener('click', function (e) {
                e.stopPropagation();

                if (container.classList.contains('collapsed')) {
                    // РАЗВОРАЧИВАНИЕ (smooth expand)
                    container.classList.remove('collapsed');
                    container.style.height = '73px';
                    setTimeout(() => {
                        container.style.height = `${lastHeight}px`;
                    }, 10);
                } else {
                    // СВОРАЧИВАНИЕ (smooth collapse)
                    lastHeight = container.offsetHeight;
                    container.style.height = `${lastHeight}px`;
                    setTimeout(() => {
                        container.style.height = '73px';
                    }, 10);
                    container.classList.add('collapsed');
                }
            });
            // Profile button functionality
            const profileBtn = document.querySelector('.profile-btn');

            profileBtn.addEventListener('click', function () {
                window.location.href = 'lk';
            });

            // Draggable functionality
            const header = document.querySelector('.header');
            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('.menu-btn, .search-container, .profile-btn')) return; // Prevent drag on interactive elements
                isDragging = true;
                const rect = container.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                container.style.position = 'absolute';
                container.style.left = `${rect.left}px`;
                container.style.top = `${rect.top}px`;
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    container.style.left = `${e.clientX - offsetX}px`;
                    container.style.top = `${e.clientY - offsetY}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Resizable functionality
            const resizer = document.querySelector('.resizer');
            let isResizing = false;
            let startX, startY, startWidth, startHeight;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(document.defaultView.getComputedStyle(container).width, 10);
                startHeight = parseInt(document.defaultView.getComputedStyle(container).height, 10);
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                // Изменяем размер только если мы НЕ в свернутом состоянии
                if (isResizing && !container.classList.contains('collapsed')) {
                    // Мы меняем только высоту, так как ширину зафиксировали ранее
                    const height = Math.max(400, startHeight + e.clientY - startY);
                    container.style.height = `${height}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
            });


            async function loadRouteFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const routeId = urlParams.get('id');
                const routeType = urlParams.get('type');

                if (!routeId || !routeType) return;

                console.log(`Загрузка маршрута: ID=${routeId}, Type=${routeType}`);

                try {
                    const response = await fetch(`/api/get-route-details?id=${routeId}&type=${routeType}`);
                    const data = await response.json();

                    if (!response.ok) {
                        alert('Ошибка загрузки маршрута: ' + (data.error || 'Неизвестная ошибка'));
                        return;
                    }

                    // 1. Устанавливаем имя
                    routeName = data.name || 'Маршрут';
                    document.querySelector('.modal-title').textContent = routeName;

                    // 2. Очищаем текущие маркеры
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];
                    pointNames = [];

                    // 3. Ставим точки на карту
                    if (data.points && data.points.length > 0) {
                        const group = new L.featureGroup();

                        data.points.forEach((pt, index) => {
                            const lat = pt.lat;
                            const lng = pt.lng;

                            const marker = L.marker([lat, lng]).addTo(map);
                            marker.bindPopup(pt.name || "Точка маршрута");

                            markers.push(marker);
                            pointNames.push(pt.name || `Точка ${index + 1}`);

                            group.addLayer(marker);
                        });

                        // Обновляем списки в интерфейсе
                        updatePointsList();
                        map.fitBounds(group.getBounds().pad(0.1));

                        // 4. Строим линию маршрута
                        if (markers.length >= 2) {
                            await buildRoute();
                            updateDistanceList();
                            updateTitle();
                        }
                    }

                    // 5. Загружаем и обновляем расписание (вкладка "Дни"), если есть
                    if (data.schedule && data.schedule.length > 0) {
                        const daysList = document.querySelector('#tab-content-days .days-list');
                        daysList.innerHTML = ''; // Очищаем
                        data.schedule.forEach(sch => {
                            const dayItem = document.createElement('div');
                            dayItem.className = 'day-item';
                            dayItem.textContent = `День ${sch.point_index}: ${sch.visit_date} ${sch.visit_time} (${sch.note || ''})`;
                            daysList.appendChild(dayItem);
                        });
                    }

                } catch (error) {
                    console.error('Ошибка при инициализации маршрута:', error);
                }
            }
            // Запускаем загрузку
            loadRouteFromUrl();



        });
    </script>
</body>

</html>