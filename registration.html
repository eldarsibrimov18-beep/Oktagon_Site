<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <title>Регистрация</title>
</head>

<body>
  <div id="app">
    <div class="container-2">
      <form class="registration-form" @submit.prevent="submitForm" method="post" action="/registration">
        <div class="form-header">
          <h1><i class="fas fa-mountain"></i> Регистрация</h1>
        </div>

        <div class="form-group">
          <label class="form-label" for="firstName">Имя</label>
          <input type="text" id="firstName" class="form-input" v-model="formData.firstName"
            @blur="validateField('firstName')" placeholder="Введите ваше имя" />
          <div class="error-message" v-if="errors.firstName">
            <i class="fas fa-exclamation-circle"></i> {{ errors.firstName }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="lastName">Фамилия</label>
          <input type="text" id="lastName" class="form-input" v-model="formData.lastName"
            @blur="validateField('lastName')" placeholder="Введите вашу фамилию" />
          <div class="error-message" v-if="errors.lastName">
            <i class="fas fa-exclamation-circle"></i> {{ errors.lastName }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="email">Email</label>
          <input type="email" id="email" class="form-input" v-model="formData.email" @blur="validateField('email')"
            placeholder="example@mail.com" />
          <div class="error-message" v-if="errors.email">
            <i class="fas fa-exclamation-circle"></i> {{ errors.email }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Пароль</label>
          <div class="password-wrapper">
            <input :type="showPassword ? 'text' : 'password'" id="password" class="form-input"
              v-model="formData.password" @blur="validateField('password')" placeholder="Не менее 8 символов" />
            <button type="button" class="password-toggle" @click="togglePasswordVisibility">
              <i :class="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
          <div class="error-message" v-if="errors.password">
            <i class="fas fa-exclamation-circle"></i> {{ errors.password }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="role">Укажите вашу роль</label>
          <div class="select-wrapper">
            <select id="role" class="form-input" v-model="formData.role" @change="validateField('role')">
              <option value="" disabled selected>Выберите роль</option>
              <option value="organizer">Организатор</option>
              <option value="participant">Участник</option>
            </select>
          </div>
          <div class="error-message" v-if="errors.role">
            <i class="fas fa-exclamation-circle"></i> {{ errors.role }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="experience">Укажите ваш уровень подготовки</label>
          <div class="select-wrapper">
            <select id="experience" class="form-input" v-model="formData.experience"
              @change="validateField('experience')">
              <option value="" disabled selected>
                Выберите уровень подготовки
              </option>
              <option value="beginner">Начинающий (1-3 похода)</option>
              <option value="amateur">Любитель (4-10 походов)</option>
              <option value="experienced">Опытный (более 10 походов)</option>
            </select>
          </div>
          <div class="error-message" v-if="errors.experience">
            <i class="fas fa-exclamation-circle"></i> {{ errors.experience }}
          </div>
        </div>

        <button type="submit" class="submit-btn" :disabled="isSubmitting">
          <span v-if="!isSubmitting">
            <i class="fas fa-user-plus"></i>
            <p>Зарегистрироваться</p>
          </span>
          <span v-else>
            <i class="fas fa-spinner fa-spin"></i> Обработка...
          </span>
        </button>
        <div class="reg-a">
          <a href="./autorization">У вас есть аккаунт? Войти</a>
        </div>

        <div class="success-message" v-if="submissionSuccess">
          <i class="fas fa-check-circle"></i> Регистрация успешно завершена!
          Добро пожаловать в наше сообщество!
        </div>
      </form>
    </div>

    <!-- Футер -->
    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-about">
            <div class="footer-logo">TrekPlan</div>
            <p>
              Приложение для планирования маршрутов активного отдыха.
              Открывайте новые места и создавайте незабываемые приключения с
              TrekPlan.
            </p>
          </div>

          <div class="footer-links">
            <h3>Навигация</h3>
            <ul>
              <li><a href="./">Главная</a></li>
              <li><a href="#about">О приложении</a></li>
              <li><a href="#features">Возможности</a></li>
            </ul>
          </div>

          <div class="footer-contact">
            <h3>Контакты</h3>
            <p><i class="fas fa-envelope"></i> info@trekplan.com</p>
            <p><i class="fas fa-phone"></i> +7 (999) 123-45-67</p>
            <p>
              <i class="fas fa-map-marker-alt"></i> Москва, ул. Туристическая,
              15
            </p>
            <p><i class="fas fa-clock"></i> Пн-Пт: 9:00-18:00</p>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          formData: {
            firstName: "",
            lastName: "",
            email: "",
            password: "",
            role: "",
            experience: "",
          },
          errors: {
            firstName: "",
            lastName: "",
            email: "",
            password: "",
            role: "",
            experience: "",
          },
          showPassword: false,
          isSubmitting: false,
          submissionSuccess: false,
        };
      },
      methods: {
        validateField(fieldName) {
          const value = this.formData[fieldName];

          switch (fieldName) {
            case "firstName":
              this.errors.firstName =
                value.length >= 2
                  ? ""
                  : "Имя должно содержать минимум 2 символа";
              break;
            case "lastName":
              this.errors.lastName =
                value.length >= 2
                  ? ""
                  : "Фамилия должна содержать минимум 2 символа";
              break;
            case "email":
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              this.errors.email = emailRegex.test(value)
                ? ""
                : "Введите корректный email адрес";
              break;
            case "password":
              this.errors.password =
                value.length >= 8
                  ? ""
                  : "Пароль должен содержать минимум 8 символов";
              break;
            case "role":
              this.errors.role = value
                ? ""
                : "Пожалуйста, выберите вашу роль";
              break;
            case "experience":
              this.errors.experience = value
                ? ""
                : "Пожалуйста, выберите ваш уровень подготовки";
              break;
          }
        },

        validateForm() {
          Object.keys(this.formData).forEach((field) => {
            this.validateField(field);
          });

          return Object.values(this.errors).every((error) => error === "");
        },

        async submitForm() {
          if (!this.validateForm()) {
            return;
          }
          this.isSubmitting = true;

          try {
            const response = await fetch('/registration', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(this.formData)
            });

            const result = await response.json();

            if (response.ok && result.status === "ok") {
              this.submissionSuccess = true;
              if (result.role === "organizer") {
                window.location.href = "/lk"; // Или куда-то для гида (например, страница создания маршрутов, если будет)
              } else {
                window.location.href = "/trek";
              }
            } else {
              alert(result.message || "Ошибка при регистрации");
            }
          } catch (error) {
            console.error(error);
            alert("Ошибка сети или сервера: " + (e.message || "Неизвестная ошибка"));
            this.showModal = false;
          } finally {
            this.isSubmitting = false;
          }
        },
        resetForm() {
          this.formData = {
            firstName: "",
            lastName: "",
            email: "",
            password: "",
            role: "",
            experience: "",
          };

          Object.keys(this.errors).forEach((key) => {
            this.errors[key] = "";
          });
        },

        togglePasswordVisibility() {
          this.showPassword = !this.showPassword;
        },
      },
    }).mount("#app");
  </script>
</body>

</html>